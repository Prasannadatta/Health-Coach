{
 "cells": [
  {
   "cell_type": "code",
   "execution_count": 1,
   "metadata": {},
   "outputs": [
    {
     "name": "stdout",
     "output_type": "stream",
     "text": [
      "Loading recipes from: ../data/recipes-with-nutrition.csv\n",
      "Loaded 39447 recipes.\n",
      "Starting QA generation for 50 pairs...\n",
      "  Retry search (1/8) for unsalted butter...\n",
      "  Retry search (2/8) for unsalted butter...\n",
      "  Retry search (3/8) for unsalted butter...\n",
      "✅ Search OK: unsalted butter\n",
      "  FDC ID: 2056610\n",
      "  Retry details (1/8) for unsalted butter...\n",
      "  Retry details (2/8) for unsalted butter...\n",
      "  Retry details (3/8) for unsalted butter...\n",
      "✅ DATA Fetch: unsalted butter\n",
      "    raw calories (per USDA serving): 714.0\n",
      "    raw proteins (per USDA serving): 0.0\n",
      "    final per gram c: 51.0\n",
      "    final per gram p: 0.0\n",
      "    =======================================\n",
      "  Retry search (1/8) for scallions...\n",
      "  Retry search (2/8) for scallions...\n",
      "✅ Search OK: scallions\n",
      "  FDC ID: 170005\n",
      "✅ DATA Fetch: scallions\n",
      "    raw calories (per USDA serving): 32.0\n",
      "    raw proteins (per USDA serving): 1.83\n",
      "    final per gram c: 0.32\n",
      "    final per gram p: 0.0183\n",
      "    =======================================\n",
      "✅ Search OK: garlic\n",
      "  FDC ID: 1662203\n",
      "  Retry details (1/8) for garlic...\n",
      "  Retry details (2/8) for garlic...\n",
      "  Retry details (3/8) for garlic...\n",
      "  Retry details (4/8) for garlic...\n",
      "  Retry details (5/8) for garlic...\n",
      "  Retry details (6/8) for garlic...\n",
      "  Retry details (7/8) for garlic...\n",
      "  Retry details (8/8) for garlic...\n",
      "❌ Detail fetch failed: garlic\n",
      "  Retry search (1/8) for spinach...\n",
      "✅ Search OK: spinach\n",
      "  FDC ID: 2664391\n",
      "  Retry details (1/8) for spinach...\n",
      "✅ DATA Fetch: spinach\n",
      "    raw calories (per USDA serving): 18.0\n",
      "    raw proteins (per USDA serving): 1.18\n",
      "    final per gram c: 0.21176470588235294\n",
      "    final per gram p: 0.01388235294117647\n",
      "    =======================================\n",
      "  Retry search (1/8) for eggs...\n",
      "  Retry search (2/8) for eggs...\n",
      "  Retry search (3/8) for eggs...\n",
      "  Retry search (4/8) for eggs...\n",
      "  Retry search (5/8) for eggs...\n",
      "  Retry search (6/8) for eggs...\n",
      "  Retry search (7/8) for eggs...\n",
      "  Retry search (8/8) for eggs...\n",
      "❌ Search failed: eggs\n",
      "  Retry search (1/8) for breadcrumbs...\n",
      "  Retry search (2/8) for breadcrumbs...\n",
      "✅ Search OK: breadcrumbs\n",
      "  FDC ID: 2290286\n",
      "  Retry details (1/8) for breadcrumbs...\n",
      "  Retry details (2/8) for breadcrumbs...\n",
      "  Retry details (3/8) for breadcrumbs...\n",
      "  Retry details (4/8) for breadcrumbs...\n",
      "✅ DATA Fetch: breadcrumbs\n",
      "    raw calories (per USDA serving): 0.0\n",
      "    raw proteins (per USDA serving): 0.0\n",
      "    final per gram c: 0.0\n",
      "    final per gram p: 0.0\n",
      "    =======================================\n",
      "  Retry search (1/8) for Parmesan cheese...\n",
      "  Retry search (2/8) for Parmesan cheese...\n",
      "  Retry search (3/8) for Parmesan cheese...\n",
      "  Retry search (4/8) for Parmesan cheese...\n",
      "  Retry search (5/8) for Parmesan cheese...\n",
      "  Retry search (6/8) for Parmesan cheese...\n",
      "  Retry search (7/8) for Parmesan cheese...\n",
      "  Retry search (8/8) for Parmesan cheese...\n",
      "❌ Search failed: Parmesan cheese\n",
      "  Retry search (1/8) for ricotta...\n",
      "  Retry search (2/8) for ricotta...\n",
      "  Retry search (3/8) for ricotta...\n",
      "  Retry search (4/8) for ricotta...\n",
      "  Retry search (5/8) for ricotta...\n",
      "  Retry search (6/8) for ricotta...\n",
      "  Retry search (7/8) for ricotta...\n",
      "  Retry search (8/8) for ricotta...\n",
      "❌ Search failed: ricotta\n",
      "  Retry search (1/8) for feta...\n",
      "  Retry search (2/8) for feta...\n",
      "  Retry search (3/8) for feta...\n",
      "  Retry search (4/8) for feta...\n",
      "  Retry search (5/8) for feta...\n",
      "  Retry search (6/8) for feta...\n",
      "  Retry search (7/8) for feta...\n",
      "  Retry search (8/8) for feta...\n",
      "❌ Search failed: feta\n",
      "  Retry search (1/8) for parsley...\n",
      "  Retry search (2/8) for parsley...\n",
      "✅ Search OK: parsley\n",
      "  FDC ID: 2670943\n",
      "  Retry details (1/8) for parsley...\n",
      "  Retry details (2/8) for parsley...\n",
      "  Retry details (3/8) for parsley...\n",
      "  Retry details (4/8) for parsley...\n",
      "  Retry details (5/8) for parsley...\n",
      "  Retry details (6/8) for parsley...\n",
      "  Retry details (7/8) for parsley...\n",
      "  Retry details (8/8) for parsley...\n",
      "❌ Detail fetch failed: parsley\n",
      "  Retry search (1/8) for lemon...\n",
      "  Retry search (2/8) for lemon...\n",
      "  Retry search (3/8) for lemon...\n",
      "  Retry search (4/8) for lemon...\n",
      "  Retry search (5/8) for lemon...\n",
      "  Retry search (6/8) for lemon...\n",
      "  Retry search (7/8) for lemon...\n",
      "  Retry search (8/8) for lemon...\n",
      "❌ Search failed: lemon\n",
      "  Retry search (1/8) for kosher salt...\n",
      "✅ Search OK: kosher salt\n",
      "  FDC ID: 1965739\n",
      "  Retry details (1/8) for kosher salt...\n",
      "  Retry details (2/8) for kosher salt...\n",
      "  Retry details (3/8) for kosher salt...\n",
      "  Retry details (4/8) for kosher salt...\n",
      "✅ DATA Fetch: kosher salt\n",
      "    raw calories (per USDA serving): 0.0\n",
      "    raw proteins (per USDA serving): 0.0\n",
      "    final per gram c: 0.0\n",
      "    final per gram p: 0.0\n",
      "    =======================================\n",
      "  Retry search (1/8) for black pepper...\n",
      "  Retry search (2/8) for black pepper...\n",
      "  Retry search (3/8) for black pepper...\n",
      "  Retry search (4/8) for black pepper...\n",
      "  Retry search (5/8) for black pepper...\n",
      "  Retry search (6/8) for black pepper...\n",
      "  Retry search (7/8) for black pepper...\n",
      "  Retry search (8/8) for black pepper...\n",
      "❌ Search failed: black pepper\n",
      "Skipping 'Spinach 'Cookies'' (163.0 kcal/serv) outside [250, 1500]\n",
      "  Retry search (1/8) for water...\n",
      "  Retry search (2/8) for water...\n",
      "  Retry search (3/8) for water...\n",
      "  Retry search (4/8) for water...\n",
      "  Retry search (5/8) for water...\n",
      "  Retry search (6/8) for water...\n",
      "  Retry search (7/8) for water...\n",
      "  Retry search (8/8) for water...\n",
      "❌ Search failed: water\n",
      "  Retry search (1/8) for yeast...\n",
      "  Retry search (2/8) for yeast...\n",
      "  Retry search (3/8) for yeast...\n",
      "  Retry search (4/8) for yeast...\n",
      "  Retry search (5/8) for yeast...\n",
      "  Retry search (6/8) for yeast...\n",
      "  Retry search (7/8) for yeast...\n",
      "  Retry search (8/8) for yeast...\n",
      "❌ Search failed: yeast\n",
      "  Retry search (1/8) for sugar...\n",
      "  Retry search (2/8) for sugar...\n",
      "  Retry search (3/8) for sugar...\n",
      "  Retry search (4/8) for sugar...\n",
      "  Retry search (5/8) for sugar...\n",
      "✅ Search OK: sugar\n",
      "  FDC ID: 2021609\n",
      "  Retry details (1/8) for sugar...\n",
      "  Retry details (2/8) for sugar...\n",
      "  Retry details (3/8) for sugar...\n",
      "  Retry details (4/8) for sugar...\n",
      "  Retry details (5/8) for sugar...\n",
      "  Retry details (6/8) for sugar...\n",
      "  Retry details (7/8) for sugar...\n",
      "  Retry details (8/8) for sugar...\n",
      "❌ Detail fetch failed: sugar\n",
      "  Retry search (1/8) for whole milk...\n",
      "✅ Search OK: whole milk\n",
      "  FDC ID: 2463968\n",
      "  Retry details (1/8) for whole milk...\n",
      "  Retry details (2/8) for whole milk...\n",
      "  Retry details (3/8) for whole milk...\n",
      "  Retry details (4/8) for whole milk...\n",
      "  Retry details (5/8) for whole milk...\n",
      "  Retry details (6/8) for whole milk...\n",
      "  Retry details (7/8) for whole milk...\n",
      "  Retry details (8/8) for whole milk...\n",
      "❌ Detail fetch failed: whole milk\n",
      "  Retry search (1/8) for egg...\n",
      "  Retry search (2/8) for egg...\n",
      "  Retry search (3/8) for egg...\n",
      "  Retry search (4/8) for egg...\n",
      "  Retry search (5/8) for egg...\n",
      "  Retry search (6/8) for egg...\n",
      "  Retry search (7/8) for egg...\n",
      "  Retry search (8/8) for egg...\n",
      "❌ Search failed: egg\n",
      "  Retry search (1/8) for bread flour...\n",
      "  Retry search (2/8) for bread flour...\n",
      "  Retry search (3/8) for bread flour...\n",
      "  Retry search (4/8) for bread flour...\n",
      "  Retry search (5/8) for bread flour...\n",
      "  Retry search (6/8) for bread flour...\n",
      "  Retry search (7/8) for bread flour...\n",
      "  Retry search (8/8) for bread flour...\n",
      "❌ Search failed: bread flour\n",
      "  Retry search (1/8) for vegetable oil...\n",
      "  Retry search (2/8) for vegetable oil...\n",
      "  Retry search (3/8) for vegetable oil...\n",
      "  Retry search (4/8) for vegetable oil...\n",
      "  Retry search (5/8) for vegetable oil...\n",
      "  Retry search (6/8) for vegetable oil...\n",
      "  Retry search (7/8) for vegetable oil...\n",
      "  Retry search (8/8) for vegetable oil...\n",
      "❌ Search failed: vegetable oil\n",
      "✅ Search OK: salt\n",
      "  FDC ID: 2120877\n",
      "  Retry details (1/8) for salt...\n",
      "  Retry details (2/8) for salt...\n",
      "  Retry details (3/8) for salt...\n",
      "  Retry details (4/8) for salt...\n",
      "  Retry details (5/8) for salt...\n"
     ]
    },
    {
     "ename": "KeyboardInterrupt",
     "evalue": "",
     "output_type": "error",
     "traceback": [
      "\u001b[31m---------------------------------------------------------------------------\u001b[39m",
      "\u001b[31mKeyboardInterrupt\u001b[39m                         Traceback (most recent call last)",
      "\u001b[36mCell\u001b[39m\u001b[36m \u001b[39m\u001b[32mIn[1]\u001b[39m\u001b[32m, line 520\u001b[39m\n\u001b[32m    516\u001b[39m     \u001b[38;5;28mprint\u001b[39m(\u001b[33mf\u001b[39m\u001b[33m\"\u001b[39m\u001b[33mOutput saved to: \u001b[39m\u001b[38;5;132;01m{\u001b[39;00mOUTPUT_JSON\u001b[38;5;132;01m}\u001b[39;00m\u001b[33m\"\u001b[39m)\n\u001b[32m    519\u001b[39m \u001b[38;5;28;01mif\u001b[39;00m \u001b[34m__name__\u001b[39m == \u001b[33m\"\u001b[39m\u001b[33m__main__\u001b[39m\u001b[33m\"\u001b[39m:\n\u001b[32m--> \u001b[39m\u001b[32m520\u001b[39m     \u001b[43mmain\u001b[49m\u001b[43m(\u001b[49m\u001b[43m)\u001b[49m\n",
      "\u001b[36mCell\u001b[39m\u001b[36m \u001b[39m\u001b[32mIn[1]\u001b[39m\u001b[32m, line 514\u001b[39m, in \u001b[36mmain\u001b[39m\u001b[34m()\u001b[39m\n\u001b[32m    511\u001b[39m \u001b[38;5;28mprint\u001b[39m(\u001b[33mf\u001b[39m\u001b[33m\"\u001b[39m\u001b[33mLoaded \u001b[39m\u001b[38;5;132;01m{\u001b[39;00m\u001b[38;5;28mlen\u001b[39m(df)\u001b[38;5;132;01m}\u001b[39;00m\u001b[33m recipes.\u001b[39m\u001b[33m\"\u001b[39m)\n\u001b[32m    513\u001b[39m NUM_SAMPLES = \u001b[32m50\u001b[39m  \u001b[38;5;66;03m# change as needed\u001b[39;00m\n\u001b[32m--> \u001b[39m\u001b[32m514\u001b[39m qa_output = \u001b[43mcreate_qa_pairs_with_ingredient_calories\u001b[49m\u001b[43m(\u001b[49m\u001b[43mdf\u001b[49m\u001b[43m,\u001b[49m\u001b[43m \u001b[49m\u001b[43mnum_samples\u001b[49m\u001b[43m=\u001b[49m\u001b[43mNUM_SAMPLES\u001b[49m\u001b[43m)\u001b[49m\n\u001b[32m    515\u001b[39m \u001b[38;5;28mprint\u001b[39m(\u001b[33mf\u001b[39m\u001b[33m\"\u001b[39m\u001b[33m✅ Done. Generated \u001b[39m\u001b[38;5;132;01m{\u001b[39;00m\u001b[38;5;28mlen\u001b[39m(qa_output)\u001b[38;5;132;01m}\u001b[39;00m\u001b[33m QA pairs total.\u001b[39m\u001b[33m\"\u001b[39m)\n\u001b[32m    516\u001b[39m \u001b[38;5;28mprint\u001b[39m(\u001b[33mf\u001b[39m\u001b[33m\"\u001b[39m\u001b[33mOutput saved to: \u001b[39m\u001b[38;5;132;01m{\u001b[39;00mOUTPUT_JSON\u001b[38;5;132;01m}\u001b[39;00m\u001b[33m\"\u001b[39m)\n",
      "\u001b[36mCell\u001b[39m\u001b[36m \u001b[39m\u001b[32mIn[1]\u001b[39m\u001b[32m, line 358\u001b[39m, in \u001b[36mcreate_qa_pairs_with_ingredient_calories\u001b[39m\u001b[34m(df, num_samples)\u001b[39m\n\u001b[32m    355\u001b[39m \u001b[38;5;28;01mif\u001b[39;00m weight <= \u001b[32m0\u001b[39m:\n\u001b[32m    356\u001b[39m     \u001b[38;5;28;01mcontinue\u001b[39;00m\n\u001b[32m--> \u001b[39m\u001b[32m358\u001b[39m cal_per_unit, pro_per_unit = \u001b[43mget_food_calories\u001b[49m\u001b[43m(\u001b[49m\u001b[43mfood_name\u001b[49m\u001b[43m,\u001b[49m\u001b[43m \u001b[49m\u001b[43mweight\u001b[49m\u001b[43m)\u001b[49m\n\u001b[32m    360\u001b[39m ingredient_total_cal = cal_per_unit * weight\n\u001b[32m    361\u001b[39m ingredient_total_pro = pro_per_unit * weight\n",
      "\u001b[36mCell\u001b[39m\u001b[36m \u001b[39m\u001b[32mIn[1]\u001b[39m\u001b[32m, line 71\u001b[39m, in \u001b[36mget_food_calories\u001b[39m\u001b[34m(food_name, weight_grams)\u001b[39m\n\u001b[32m     69\u001b[39m detail_data = \u001b[38;5;28;01mNone\u001b[39;00m\n\u001b[32m     70\u001b[39m \u001b[38;5;28;01mfor\u001b[39;00m attempt \u001b[38;5;129;01min\u001b[39;00m \u001b[38;5;28mrange\u001b[39m(\u001b[32m8\u001b[39m):\n\u001b[32m---> \u001b[39m\u001b[32m71\u001b[39m     resp = \u001b[43mrequests\u001b[49m\u001b[43m.\u001b[49m\u001b[43mget\u001b[49m\u001b[43m(\u001b[49m\u001b[43mdetail_url\u001b[49m\u001b[43m)\u001b[49m\n\u001b[32m     72\u001b[39m     \u001b[38;5;28;01mif\u001b[39;00m resp.status_code == \u001b[32m200\u001b[39m \u001b[38;5;129;01mand\u001b[39;00m \u001b[33m\"\u001b[39m\u001b[33mapplication/json\u001b[39m\u001b[33m\"\u001b[39m \u001b[38;5;129;01min\u001b[39;00m resp.headers.get(\u001b[33m\"\u001b[39m\u001b[33mContent-Type\u001b[39m\u001b[33m\"\u001b[39m, \u001b[33m\"\u001b[39m\u001b[33m\"\u001b[39m):\n\u001b[32m     73\u001b[39m         detail_data = resp.json()\n",
      "\u001b[36mFile \u001b[39m\u001b[32m~/Projects/Health-Coach/.venv/lib/python3.13/site-packages/requests/api.py:73\u001b[39m, in \u001b[36mget\u001b[39m\u001b[34m(url, params, **kwargs)\u001b[39m\n\u001b[32m     62\u001b[39m \u001b[38;5;28;01mdef\u001b[39;00m\u001b[38;5;250m \u001b[39m\u001b[34mget\u001b[39m(url, params=\u001b[38;5;28;01mNone\u001b[39;00m, **kwargs):\n\u001b[32m     63\u001b[39m \u001b[38;5;250m    \u001b[39m\u001b[33mr\u001b[39m\u001b[33;03m\"\"\"Sends a GET request.\u001b[39;00m\n\u001b[32m     64\u001b[39m \n\u001b[32m     65\u001b[39m \u001b[33;03m    :param url: URL for the new :class:`Request` object.\u001b[39;00m\n\u001b[32m   (...)\u001b[39m\u001b[32m     70\u001b[39m \u001b[33;03m    :rtype: requests.Response\u001b[39;00m\n\u001b[32m     71\u001b[39m \u001b[33;03m    \"\"\"\u001b[39;00m\n\u001b[32m---> \u001b[39m\u001b[32m73\u001b[39m     \u001b[38;5;28;01mreturn\u001b[39;00m \u001b[43mrequest\u001b[49m\u001b[43m(\u001b[49m\u001b[33;43m\"\u001b[39;49m\u001b[33;43mget\u001b[39;49m\u001b[33;43m\"\u001b[39;49m\u001b[43m,\u001b[49m\u001b[43m \u001b[49m\u001b[43murl\u001b[49m\u001b[43m,\u001b[49m\u001b[43m \u001b[49m\u001b[43mparams\u001b[49m\u001b[43m=\u001b[49m\u001b[43mparams\u001b[49m\u001b[43m,\u001b[49m\u001b[43m \u001b[49m\u001b[43m*\u001b[49m\u001b[43m*\u001b[49m\u001b[43mkwargs\u001b[49m\u001b[43m)\u001b[49m\n",
      "\u001b[36mFile \u001b[39m\u001b[32m~/Projects/Health-Coach/.venv/lib/python3.13/site-packages/requests/api.py:59\u001b[39m, in \u001b[36mrequest\u001b[39m\u001b[34m(method, url, **kwargs)\u001b[39m\n\u001b[32m     55\u001b[39m \u001b[38;5;66;03m# By using the 'with' statement we are sure the session is closed, thus we\u001b[39;00m\n\u001b[32m     56\u001b[39m \u001b[38;5;66;03m# avoid leaving sockets open which can trigger a ResourceWarning in some\u001b[39;00m\n\u001b[32m     57\u001b[39m \u001b[38;5;66;03m# cases, and look like a memory leak in others.\u001b[39;00m\n\u001b[32m     58\u001b[39m \u001b[38;5;28;01mwith\u001b[39;00m sessions.Session() \u001b[38;5;28;01mas\u001b[39;00m session:\n\u001b[32m---> \u001b[39m\u001b[32m59\u001b[39m     \u001b[38;5;28;01mreturn\u001b[39;00m \u001b[43msession\u001b[49m\u001b[43m.\u001b[49m\u001b[43mrequest\u001b[49m\u001b[43m(\u001b[49m\u001b[43mmethod\u001b[49m\u001b[43m=\u001b[49m\u001b[43mmethod\u001b[49m\u001b[43m,\u001b[49m\u001b[43m \u001b[49m\u001b[43murl\u001b[49m\u001b[43m=\u001b[49m\u001b[43murl\u001b[49m\u001b[43m,\u001b[49m\u001b[43m \u001b[49m\u001b[43m*\u001b[49m\u001b[43m*\u001b[49m\u001b[43mkwargs\u001b[49m\u001b[43m)\u001b[49m\n",
      "\u001b[36mFile \u001b[39m\u001b[32m~/Projects/Health-Coach/.venv/lib/python3.13/site-packages/requests/sessions.py:589\u001b[39m, in \u001b[36mSession.request\u001b[39m\u001b[34m(self, method, url, params, data, headers, cookies, files, auth, timeout, allow_redirects, proxies, hooks, stream, verify, cert, json)\u001b[39m\n\u001b[32m    584\u001b[39m send_kwargs = {\n\u001b[32m    585\u001b[39m     \u001b[33m\"\u001b[39m\u001b[33mtimeout\u001b[39m\u001b[33m\"\u001b[39m: timeout,\n\u001b[32m    586\u001b[39m     \u001b[33m\"\u001b[39m\u001b[33mallow_redirects\u001b[39m\u001b[33m\"\u001b[39m: allow_redirects,\n\u001b[32m    587\u001b[39m }\n\u001b[32m    588\u001b[39m send_kwargs.update(settings)\n\u001b[32m--> \u001b[39m\u001b[32m589\u001b[39m resp = \u001b[38;5;28;43mself\u001b[39;49m\u001b[43m.\u001b[49m\u001b[43msend\u001b[49m\u001b[43m(\u001b[49m\u001b[43mprep\u001b[49m\u001b[43m,\u001b[49m\u001b[43m \u001b[49m\u001b[43m*\u001b[49m\u001b[43m*\u001b[49m\u001b[43msend_kwargs\u001b[49m\u001b[43m)\u001b[49m\n\u001b[32m    591\u001b[39m \u001b[38;5;28;01mreturn\u001b[39;00m resp\n",
      "\u001b[36mFile \u001b[39m\u001b[32m~/Projects/Health-Coach/.venv/lib/python3.13/site-packages/requests/sessions.py:703\u001b[39m, in \u001b[36mSession.send\u001b[39m\u001b[34m(self, request, **kwargs)\u001b[39m\n\u001b[32m    700\u001b[39m start = preferred_clock()\n\u001b[32m    702\u001b[39m \u001b[38;5;66;03m# Send the request\u001b[39;00m\n\u001b[32m--> \u001b[39m\u001b[32m703\u001b[39m r = \u001b[43madapter\u001b[49m\u001b[43m.\u001b[49m\u001b[43msend\u001b[49m\u001b[43m(\u001b[49m\u001b[43mrequest\u001b[49m\u001b[43m,\u001b[49m\u001b[43m \u001b[49m\u001b[43m*\u001b[49m\u001b[43m*\u001b[49m\u001b[43mkwargs\u001b[49m\u001b[43m)\u001b[49m\n\u001b[32m    705\u001b[39m \u001b[38;5;66;03m# Total elapsed time of the request (approximately)\u001b[39;00m\n\u001b[32m    706\u001b[39m elapsed = preferred_clock() - start\n",
      "\u001b[36mFile \u001b[39m\u001b[32m~/Projects/Health-Coach/.venv/lib/python3.13/site-packages/requests/adapters.py:644\u001b[39m, in \u001b[36mHTTPAdapter.send\u001b[39m\u001b[34m(self, request, stream, timeout, verify, cert, proxies)\u001b[39m\n\u001b[32m    641\u001b[39m     timeout = TimeoutSauce(connect=timeout, read=timeout)\n\u001b[32m    643\u001b[39m \u001b[38;5;28;01mtry\u001b[39;00m:\n\u001b[32m--> \u001b[39m\u001b[32m644\u001b[39m     resp = \u001b[43mconn\u001b[49m\u001b[43m.\u001b[49m\u001b[43murlopen\u001b[49m\u001b[43m(\u001b[49m\n\u001b[32m    645\u001b[39m \u001b[43m        \u001b[49m\u001b[43mmethod\u001b[49m\u001b[43m=\u001b[49m\u001b[43mrequest\u001b[49m\u001b[43m.\u001b[49m\u001b[43mmethod\u001b[49m\u001b[43m,\u001b[49m\n\u001b[32m    646\u001b[39m \u001b[43m        \u001b[49m\u001b[43murl\u001b[49m\u001b[43m=\u001b[49m\u001b[43murl\u001b[49m\u001b[43m,\u001b[49m\n\u001b[32m    647\u001b[39m \u001b[43m        \u001b[49m\u001b[43mbody\u001b[49m\u001b[43m=\u001b[49m\u001b[43mrequest\u001b[49m\u001b[43m.\u001b[49m\u001b[43mbody\u001b[49m\u001b[43m,\u001b[49m\n\u001b[32m    648\u001b[39m \u001b[43m        \u001b[49m\u001b[43mheaders\u001b[49m\u001b[43m=\u001b[49m\u001b[43mrequest\u001b[49m\u001b[43m.\u001b[49m\u001b[43mheaders\u001b[49m\u001b[43m,\u001b[49m\n\u001b[32m    649\u001b[39m \u001b[43m        \u001b[49m\u001b[43mredirect\u001b[49m\u001b[43m=\u001b[49m\u001b[38;5;28;43;01mFalse\u001b[39;49;00m\u001b[43m,\u001b[49m\n\u001b[32m    650\u001b[39m \u001b[43m        \u001b[49m\u001b[43massert_same_host\u001b[49m\u001b[43m=\u001b[49m\u001b[38;5;28;43;01mFalse\u001b[39;49;00m\u001b[43m,\u001b[49m\n\u001b[32m    651\u001b[39m \u001b[43m        \u001b[49m\u001b[43mpreload_content\u001b[49m\u001b[43m=\u001b[49m\u001b[38;5;28;43;01mFalse\u001b[39;49;00m\u001b[43m,\u001b[49m\n\u001b[32m    652\u001b[39m \u001b[43m        \u001b[49m\u001b[43mdecode_content\u001b[49m\u001b[43m=\u001b[49m\u001b[38;5;28;43;01mFalse\u001b[39;49;00m\u001b[43m,\u001b[49m\n\u001b[32m    653\u001b[39m \u001b[43m        \u001b[49m\u001b[43mretries\u001b[49m\u001b[43m=\u001b[49m\u001b[38;5;28;43mself\u001b[39;49m\u001b[43m.\u001b[49m\u001b[43mmax_retries\u001b[49m\u001b[43m,\u001b[49m\n\u001b[32m    654\u001b[39m \u001b[43m        \u001b[49m\u001b[43mtimeout\u001b[49m\u001b[43m=\u001b[49m\u001b[43mtimeout\u001b[49m\u001b[43m,\u001b[49m\n\u001b[32m    655\u001b[39m \u001b[43m        \u001b[49m\u001b[43mchunked\u001b[49m\u001b[43m=\u001b[49m\u001b[43mchunked\u001b[49m\u001b[43m,\u001b[49m\n\u001b[32m    656\u001b[39m \u001b[43m    \u001b[49m\u001b[43m)\u001b[49m\n\u001b[32m    658\u001b[39m \u001b[38;5;28;01mexcept\u001b[39;00m (ProtocolError, \u001b[38;5;167;01mOSError\u001b[39;00m) \u001b[38;5;28;01mas\u001b[39;00m err:\n\u001b[32m    659\u001b[39m     \u001b[38;5;28;01mraise\u001b[39;00m \u001b[38;5;167;01mConnectionError\u001b[39;00m(err, request=request)\n",
      "\u001b[36mFile \u001b[39m\u001b[32m~/Projects/Health-Coach/.venv/lib/python3.13/site-packages/urllib3/connectionpool.py:787\u001b[39m, in \u001b[36mHTTPConnectionPool.urlopen\u001b[39m\u001b[34m(self, method, url, body, headers, retries, redirect, assert_same_host, timeout, pool_timeout, release_conn, chunked, body_pos, preload_content, decode_content, **response_kw)\u001b[39m\n\u001b[32m    784\u001b[39m response_conn = conn \u001b[38;5;28;01mif\u001b[39;00m \u001b[38;5;129;01mnot\u001b[39;00m release_conn \u001b[38;5;28;01melse\u001b[39;00m \u001b[38;5;28;01mNone\u001b[39;00m\n\u001b[32m    786\u001b[39m \u001b[38;5;66;03m# Make the request on the HTTPConnection object\u001b[39;00m\n\u001b[32m--> \u001b[39m\u001b[32m787\u001b[39m response = \u001b[38;5;28;43mself\u001b[39;49m\u001b[43m.\u001b[49m\u001b[43m_make_request\u001b[49m\u001b[43m(\u001b[49m\n\u001b[32m    788\u001b[39m \u001b[43m    \u001b[49m\u001b[43mconn\u001b[49m\u001b[43m,\u001b[49m\n\u001b[32m    789\u001b[39m \u001b[43m    \u001b[49m\u001b[43mmethod\u001b[49m\u001b[43m,\u001b[49m\n\u001b[32m    790\u001b[39m \u001b[43m    \u001b[49m\u001b[43murl\u001b[49m\u001b[43m,\u001b[49m\n\u001b[32m    791\u001b[39m \u001b[43m    \u001b[49m\u001b[43mtimeout\u001b[49m\u001b[43m=\u001b[49m\u001b[43mtimeout_obj\u001b[49m\u001b[43m,\u001b[49m\n\u001b[32m    792\u001b[39m \u001b[43m    \u001b[49m\u001b[43mbody\u001b[49m\u001b[43m=\u001b[49m\u001b[43mbody\u001b[49m\u001b[43m,\u001b[49m\n\u001b[32m    793\u001b[39m \u001b[43m    \u001b[49m\u001b[43mheaders\u001b[49m\u001b[43m=\u001b[49m\u001b[43mheaders\u001b[49m\u001b[43m,\u001b[49m\n\u001b[32m    794\u001b[39m \u001b[43m    \u001b[49m\u001b[43mchunked\u001b[49m\u001b[43m=\u001b[49m\u001b[43mchunked\u001b[49m\u001b[43m,\u001b[49m\n\u001b[32m    795\u001b[39m \u001b[43m    \u001b[49m\u001b[43mretries\u001b[49m\u001b[43m=\u001b[49m\u001b[43mretries\u001b[49m\u001b[43m,\u001b[49m\n\u001b[32m    796\u001b[39m \u001b[43m    \u001b[49m\u001b[43mresponse_conn\u001b[49m\u001b[43m=\u001b[49m\u001b[43mresponse_conn\u001b[49m\u001b[43m,\u001b[49m\n\u001b[32m    797\u001b[39m \u001b[43m    \u001b[49m\u001b[43mpreload_content\u001b[49m\u001b[43m=\u001b[49m\u001b[43mpreload_content\u001b[49m\u001b[43m,\u001b[49m\n\u001b[32m    798\u001b[39m \u001b[43m    \u001b[49m\u001b[43mdecode_content\u001b[49m\u001b[43m=\u001b[49m\u001b[43mdecode_content\u001b[49m\u001b[43m,\u001b[49m\n\u001b[32m    799\u001b[39m \u001b[43m    \u001b[49m\u001b[43m*\u001b[49m\u001b[43m*\u001b[49m\u001b[43mresponse_kw\u001b[49m\u001b[43m,\u001b[49m\n\u001b[32m    800\u001b[39m \u001b[43m\u001b[49m\u001b[43m)\u001b[49m\n\u001b[32m    802\u001b[39m \u001b[38;5;66;03m# Everything went great!\u001b[39;00m\n\u001b[32m    803\u001b[39m clean_exit = \u001b[38;5;28;01mTrue\u001b[39;00m\n",
      "\u001b[36mFile \u001b[39m\u001b[32m~/Projects/Health-Coach/.venv/lib/python3.13/site-packages/urllib3/connectionpool.py:464\u001b[39m, in \u001b[36mHTTPConnectionPool._make_request\u001b[39m\u001b[34m(self, conn, method, url, body, headers, retries, timeout, chunked, response_conn, preload_content, decode_content, enforce_content_length)\u001b[39m\n\u001b[32m    461\u001b[39m \u001b[38;5;28;01mtry\u001b[39;00m:\n\u001b[32m    462\u001b[39m     \u001b[38;5;66;03m# Trigger any extra validation we need to do.\u001b[39;00m\n\u001b[32m    463\u001b[39m     \u001b[38;5;28;01mtry\u001b[39;00m:\n\u001b[32m--> \u001b[39m\u001b[32m464\u001b[39m         \u001b[38;5;28;43mself\u001b[39;49m\u001b[43m.\u001b[49m\u001b[43m_validate_conn\u001b[49m\u001b[43m(\u001b[49m\u001b[43mconn\u001b[49m\u001b[43m)\u001b[49m\n\u001b[32m    465\u001b[39m     \u001b[38;5;28;01mexcept\u001b[39;00m (SocketTimeout, BaseSSLError) \u001b[38;5;28;01mas\u001b[39;00m e:\n\u001b[32m    466\u001b[39m         \u001b[38;5;28mself\u001b[39m._raise_timeout(err=e, url=url, timeout_value=conn.timeout)\n",
      "\u001b[36mFile \u001b[39m\u001b[32m~/Projects/Health-Coach/.venv/lib/python3.13/site-packages/urllib3/connectionpool.py:1093\u001b[39m, in \u001b[36mHTTPSConnectionPool._validate_conn\u001b[39m\u001b[34m(self, conn)\u001b[39m\n\u001b[32m   1091\u001b[39m \u001b[38;5;66;03m# Force connect early to allow us to validate the connection.\u001b[39;00m\n\u001b[32m   1092\u001b[39m \u001b[38;5;28;01mif\u001b[39;00m conn.is_closed:\n\u001b[32m-> \u001b[39m\u001b[32m1093\u001b[39m     \u001b[43mconn\u001b[49m\u001b[43m.\u001b[49m\u001b[43mconnect\u001b[49m\u001b[43m(\u001b[49m\u001b[43m)\u001b[49m\n\u001b[32m   1095\u001b[39m \u001b[38;5;66;03m# TODO revise this, see https://github.com/urllib3/urllib3/issues/2791\u001b[39;00m\n\u001b[32m   1096\u001b[39m \u001b[38;5;28;01mif\u001b[39;00m \u001b[38;5;129;01mnot\u001b[39;00m conn.is_verified \u001b[38;5;129;01mand\u001b[39;00m \u001b[38;5;129;01mnot\u001b[39;00m conn.proxy_is_verified:\n",
      "\u001b[36mFile \u001b[39m\u001b[32m~/Projects/Health-Coach/.venv/lib/python3.13/site-packages/urllib3/connection.py:790\u001b[39m, in \u001b[36mHTTPSConnection.connect\u001b[39m\u001b[34m(self)\u001b[39m\n\u001b[32m    787\u001b[39m     \u001b[38;5;66;03m# Remove trailing '.' from fqdn hostnames to allow certificate validation\u001b[39;00m\n\u001b[32m    788\u001b[39m     server_hostname_rm_dot = server_hostname.rstrip(\u001b[33m\"\u001b[39m\u001b[33m.\u001b[39m\u001b[33m\"\u001b[39m)\n\u001b[32m--> \u001b[39m\u001b[32m790\u001b[39m     sock_and_verified = \u001b[43m_ssl_wrap_socket_and_match_hostname\u001b[49m\u001b[43m(\u001b[49m\n\u001b[32m    791\u001b[39m \u001b[43m        \u001b[49m\u001b[43msock\u001b[49m\u001b[43m=\u001b[49m\u001b[43msock\u001b[49m\u001b[43m,\u001b[49m\n\u001b[32m    792\u001b[39m \u001b[43m        \u001b[49m\u001b[43mcert_reqs\u001b[49m\u001b[43m=\u001b[49m\u001b[38;5;28;43mself\u001b[39;49m\u001b[43m.\u001b[49m\u001b[43mcert_reqs\u001b[49m\u001b[43m,\u001b[49m\n\u001b[32m    793\u001b[39m \u001b[43m        \u001b[49m\u001b[43mssl_version\u001b[49m\u001b[43m=\u001b[49m\u001b[38;5;28;43mself\u001b[39;49m\u001b[43m.\u001b[49m\u001b[43mssl_version\u001b[49m\u001b[43m,\u001b[49m\n\u001b[32m    794\u001b[39m \u001b[43m        \u001b[49m\u001b[43mssl_minimum_version\u001b[49m\u001b[43m=\u001b[49m\u001b[38;5;28;43mself\u001b[39;49m\u001b[43m.\u001b[49m\u001b[43mssl_minimum_version\u001b[49m\u001b[43m,\u001b[49m\n\u001b[32m    795\u001b[39m \u001b[43m        \u001b[49m\u001b[43mssl_maximum_version\u001b[49m\u001b[43m=\u001b[49m\u001b[38;5;28;43mself\u001b[39;49m\u001b[43m.\u001b[49m\u001b[43mssl_maximum_version\u001b[49m\u001b[43m,\u001b[49m\n\u001b[32m    796\u001b[39m \u001b[43m        \u001b[49m\u001b[43mca_certs\u001b[49m\u001b[43m=\u001b[49m\u001b[38;5;28;43mself\u001b[39;49m\u001b[43m.\u001b[49m\u001b[43mca_certs\u001b[49m\u001b[43m,\u001b[49m\n\u001b[32m    797\u001b[39m \u001b[43m        \u001b[49m\u001b[43mca_cert_dir\u001b[49m\u001b[43m=\u001b[49m\u001b[38;5;28;43mself\u001b[39;49m\u001b[43m.\u001b[49m\u001b[43mca_cert_dir\u001b[49m\u001b[43m,\u001b[49m\n\u001b[32m    798\u001b[39m \u001b[43m        \u001b[49m\u001b[43mca_cert_data\u001b[49m\u001b[43m=\u001b[49m\u001b[38;5;28;43mself\u001b[39;49m\u001b[43m.\u001b[49m\u001b[43mca_cert_data\u001b[49m\u001b[43m,\u001b[49m\n\u001b[32m    799\u001b[39m \u001b[43m        \u001b[49m\u001b[43mcert_file\u001b[49m\u001b[43m=\u001b[49m\u001b[38;5;28;43mself\u001b[39;49m\u001b[43m.\u001b[49m\u001b[43mcert_file\u001b[49m\u001b[43m,\u001b[49m\n\u001b[32m    800\u001b[39m \u001b[43m        \u001b[49m\u001b[43mkey_file\u001b[49m\u001b[43m=\u001b[49m\u001b[38;5;28;43mself\u001b[39;49m\u001b[43m.\u001b[49m\u001b[43mkey_file\u001b[49m\u001b[43m,\u001b[49m\n\u001b[32m    801\u001b[39m \u001b[43m        \u001b[49m\u001b[43mkey_password\u001b[49m\u001b[43m=\u001b[49m\u001b[38;5;28;43mself\u001b[39;49m\u001b[43m.\u001b[49m\u001b[43mkey_password\u001b[49m\u001b[43m,\u001b[49m\n\u001b[32m    802\u001b[39m \u001b[43m        \u001b[49m\u001b[43mserver_hostname\u001b[49m\u001b[43m=\u001b[49m\u001b[43mserver_hostname_rm_dot\u001b[49m\u001b[43m,\u001b[49m\n\u001b[32m    803\u001b[39m \u001b[43m        \u001b[49m\u001b[43mssl_context\u001b[49m\u001b[43m=\u001b[49m\u001b[38;5;28;43mself\u001b[39;49m\u001b[43m.\u001b[49m\u001b[43mssl_context\u001b[49m\u001b[43m,\u001b[49m\n\u001b[32m    804\u001b[39m \u001b[43m        \u001b[49m\u001b[43mtls_in_tls\u001b[49m\u001b[43m=\u001b[49m\u001b[43mtls_in_tls\u001b[49m\u001b[43m,\u001b[49m\n\u001b[32m    805\u001b[39m \u001b[43m        \u001b[49m\u001b[43massert_hostname\u001b[49m\u001b[43m=\u001b[49m\u001b[38;5;28;43mself\u001b[39;49m\u001b[43m.\u001b[49m\u001b[43massert_hostname\u001b[49m\u001b[43m,\u001b[49m\n\u001b[32m    806\u001b[39m \u001b[43m        \u001b[49m\u001b[43massert_fingerprint\u001b[49m\u001b[43m=\u001b[49m\u001b[38;5;28;43mself\u001b[39;49m\u001b[43m.\u001b[49m\u001b[43massert_fingerprint\u001b[49m\u001b[43m,\u001b[49m\n\u001b[32m    807\u001b[39m \u001b[43m    \u001b[49m\u001b[43m)\u001b[49m\n\u001b[32m    808\u001b[39m     \u001b[38;5;28mself\u001b[39m.sock = sock_and_verified.socket\n\u001b[32m    810\u001b[39m \u001b[38;5;66;03m# If an error occurs during connection/handshake we may need to release\u001b[39;00m\n\u001b[32m    811\u001b[39m \u001b[38;5;66;03m# our lock so another connection can probe the origin.\u001b[39;00m\n",
      "\u001b[36mFile \u001b[39m\u001b[32m~/Projects/Health-Coach/.venv/lib/python3.13/site-packages/urllib3/connection.py:969\u001b[39m, in \u001b[36m_ssl_wrap_socket_and_match_hostname\u001b[39m\u001b[34m(sock, cert_reqs, ssl_version, ssl_minimum_version, ssl_maximum_version, cert_file, key_file, key_password, ca_certs, ca_cert_dir, ca_cert_data, assert_hostname, assert_fingerprint, server_hostname, ssl_context, tls_in_tls)\u001b[39m\n\u001b[32m    966\u001b[39m     \u001b[38;5;28;01mif\u001b[39;00m is_ipaddress(normalized):\n\u001b[32m    967\u001b[39m         server_hostname = normalized\n\u001b[32m--> \u001b[39m\u001b[32m969\u001b[39m ssl_sock = \u001b[43mssl_wrap_socket\u001b[49m\u001b[43m(\u001b[49m\n\u001b[32m    970\u001b[39m \u001b[43m    \u001b[49m\u001b[43msock\u001b[49m\u001b[43m=\u001b[49m\u001b[43msock\u001b[49m\u001b[43m,\u001b[49m\n\u001b[32m    971\u001b[39m \u001b[43m    \u001b[49m\u001b[43mkeyfile\u001b[49m\u001b[43m=\u001b[49m\u001b[43mkey_file\u001b[49m\u001b[43m,\u001b[49m\n\u001b[32m    972\u001b[39m \u001b[43m    \u001b[49m\u001b[43mcertfile\u001b[49m\u001b[43m=\u001b[49m\u001b[43mcert_file\u001b[49m\u001b[43m,\u001b[49m\n\u001b[32m    973\u001b[39m \u001b[43m    \u001b[49m\u001b[43mkey_password\u001b[49m\u001b[43m=\u001b[49m\u001b[43mkey_password\u001b[49m\u001b[43m,\u001b[49m\n\u001b[32m    974\u001b[39m \u001b[43m    \u001b[49m\u001b[43mca_certs\u001b[49m\u001b[43m=\u001b[49m\u001b[43mca_certs\u001b[49m\u001b[43m,\u001b[49m\n\u001b[32m    975\u001b[39m \u001b[43m    \u001b[49m\u001b[43mca_cert_dir\u001b[49m\u001b[43m=\u001b[49m\u001b[43mca_cert_dir\u001b[49m\u001b[43m,\u001b[49m\n\u001b[32m    976\u001b[39m \u001b[43m    \u001b[49m\u001b[43mca_cert_data\u001b[49m\u001b[43m=\u001b[49m\u001b[43mca_cert_data\u001b[49m\u001b[43m,\u001b[49m\n\u001b[32m    977\u001b[39m \u001b[43m    \u001b[49m\u001b[43mserver_hostname\u001b[49m\u001b[43m=\u001b[49m\u001b[43mserver_hostname\u001b[49m\u001b[43m,\u001b[49m\n\u001b[32m    978\u001b[39m \u001b[43m    \u001b[49m\u001b[43mssl_context\u001b[49m\u001b[43m=\u001b[49m\u001b[43mcontext\u001b[49m\u001b[43m,\u001b[49m\n\u001b[32m    979\u001b[39m \u001b[43m    \u001b[49m\u001b[43mtls_in_tls\u001b[49m\u001b[43m=\u001b[49m\u001b[43mtls_in_tls\u001b[49m\u001b[43m,\u001b[49m\n\u001b[32m    980\u001b[39m \u001b[43m\u001b[49m\u001b[43m)\u001b[49m\n\u001b[32m    982\u001b[39m \u001b[38;5;28;01mtry\u001b[39;00m:\n\u001b[32m    983\u001b[39m     \u001b[38;5;28;01mif\u001b[39;00m assert_fingerprint:\n",
      "\u001b[36mFile \u001b[39m\u001b[32m~/Projects/Health-Coach/.venv/lib/python3.13/site-packages/urllib3/util/ssl_.py:480\u001b[39m, in \u001b[36mssl_wrap_socket\u001b[39m\u001b[34m(sock, keyfile, certfile, cert_reqs, ca_certs, server_hostname, ssl_version, ciphers, ssl_context, ca_cert_dir, key_password, ca_cert_data, tls_in_tls)\u001b[39m\n\u001b[32m    476\u001b[39m         context.load_cert_chain(certfile, keyfile, key_password)\n\u001b[32m    478\u001b[39m context.set_alpn_protocols(ALPN_PROTOCOLS)\n\u001b[32m--> \u001b[39m\u001b[32m480\u001b[39m ssl_sock = \u001b[43m_ssl_wrap_socket_impl\u001b[49m\u001b[43m(\u001b[49m\u001b[43msock\u001b[49m\u001b[43m,\u001b[49m\u001b[43m \u001b[49m\u001b[43mcontext\u001b[49m\u001b[43m,\u001b[49m\u001b[43m \u001b[49m\u001b[43mtls_in_tls\u001b[49m\u001b[43m,\u001b[49m\u001b[43m \u001b[49m\u001b[43mserver_hostname\u001b[49m\u001b[43m)\u001b[49m\n\u001b[32m    481\u001b[39m \u001b[38;5;28;01mreturn\u001b[39;00m ssl_sock\n",
      "\u001b[36mFile \u001b[39m\u001b[32m~/Projects/Health-Coach/.venv/lib/python3.13/site-packages/urllib3/util/ssl_.py:524\u001b[39m, in \u001b[36m_ssl_wrap_socket_impl\u001b[39m\u001b[34m(sock, ssl_context, tls_in_tls, server_hostname)\u001b[39m\n\u001b[32m    521\u001b[39m     SSLTransport._validate_ssl_context_for_tls_in_tls(ssl_context)\n\u001b[32m    522\u001b[39m     \u001b[38;5;28;01mreturn\u001b[39;00m SSLTransport(sock, ssl_context, server_hostname)\n\u001b[32m--> \u001b[39m\u001b[32m524\u001b[39m \u001b[38;5;28;01mreturn\u001b[39;00m \u001b[43mssl_context\u001b[49m\u001b[43m.\u001b[49m\u001b[43mwrap_socket\u001b[49m\u001b[43m(\u001b[49m\u001b[43msock\u001b[49m\u001b[43m,\u001b[49m\u001b[43m \u001b[49m\u001b[43mserver_hostname\u001b[49m\u001b[43m=\u001b[49m\u001b[43mserver_hostname\u001b[49m\u001b[43m)\u001b[49m\n",
      "\u001b[36mFile \u001b[39m\u001b[32m~/miniconda3/lib/python3.13/ssl.py:455\u001b[39m, in \u001b[36mSSLContext.wrap_socket\u001b[39m\u001b[34m(self, sock, server_side, do_handshake_on_connect, suppress_ragged_eofs, server_hostname, session)\u001b[39m\n\u001b[32m    449\u001b[39m \u001b[38;5;28;01mdef\u001b[39;00m\u001b[38;5;250m \u001b[39m\u001b[34mwrap_socket\u001b[39m(\u001b[38;5;28mself\u001b[39m, sock, server_side=\u001b[38;5;28;01mFalse\u001b[39;00m,\n\u001b[32m    450\u001b[39m                 do_handshake_on_connect=\u001b[38;5;28;01mTrue\u001b[39;00m,\n\u001b[32m    451\u001b[39m                 suppress_ragged_eofs=\u001b[38;5;28;01mTrue\u001b[39;00m,\n\u001b[32m    452\u001b[39m                 server_hostname=\u001b[38;5;28;01mNone\u001b[39;00m, session=\u001b[38;5;28;01mNone\u001b[39;00m):\n\u001b[32m    453\u001b[39m     \u001b[38;5;66;03m# SSLSocket class handles server_hostname encoding before it calls\u001b[39;00m\n\u001b[32m    454\u001b[39m     \u001b[38;5;66;03m# ctx._wrap_socket()\u001b[39;00m\n\u001b[32m--> \u001b[39m\u001b[32m455\u001b[39m     \u001b[38;5;28;01mreturn\u001b[39;00m \u001b[38;5;28;43mself\u001b[39;49m\u001b[43m.\u001b[49m\u001b[43msslsocket_class\u001b[49m\u001b[43m.\u001b[49m\u001b[43m_create\u001b[49m\u001b[43m(\u001b[49m\n\u001b[32m    456\u001b[39m \u001b[43m        \u001b[49m\u001b[43msock\u001b[49m\u001b[43m=\u001b[49m\u001b[43msock\u001b[49m\u001b[43m,\u001b[49m\n\u001b[32m    457\u001b[39m \u001b[43m        \u001b[49m\u001b[43mserver_side\u001b[49m\u001b[43m=\u001b[49m\u001b[43mserver_side\u001b[49m\u001b[43m,\u001b[49m\n\u001b[32m    458\u001b[39m \u001b[43m        \u001b[49m\u001b[43mdo_handshake_on_connect\u001b[49m\u001b[43m=\u001b[49m\u001b[43mdo_handshake_on_connect\u001b[49m\u001b[43m,\u001b[49m\n\u001b[32m    459\u001b[39m \u001b[43m        \u001b[49m\u001b[43msuppress_ragged_eofs\u001b[49m\u001b[43m=\u001b[49m\u001b[43msuppress_ragged_eofs\u001b[49m\u001b[43m,\u001b[49m\n\u001b[32m    460\u001b[39m \u001b[43m        \u001b[49m\u001b[43mserver_hostname\u001b[49m\u001b[43m=\u001b[49m\u001b[43mserver_hostname\u001b[49m\u001b[43m,\u001b[49m\n\u001b[32m    461\u001b[39m \u001b[43m        \u001b[49m\u001b[43mcontext\u001b[49m\u001b[43m=\u001b[49m\u001b[38;5;28;43mself\u001b[39;49m\u001b[43m,\u001b[49m\n\u001b[32m    462\u001b[39m \u001b[43m        \u001b[49m\u001b[43msession\u001b[49m\u001b[43m=\u001b[49m\u001b[43msession\u001b[49m\n\u001b[32m    463\u001b[39m \u001b[43m    \u001b[49m\u001b[43m)\u001b[49m\n",
      "\u001b[36mFile \u001b[39m\u001b[32m~/miniconda3/lib/python3.13/ssl.py:1076\u001b[39m, in \u001b[36mSSLSocket._create\u001b[39m\u001b[34m(cls, sock, server_side, do_handshake_on_connect, suppress_ragged_eofs, server_hostname, context, session)\u001b[39m\n\u001b[32m   1073\u001b[39m             \u001b[38;5;28;01mif\u001b[39;00m timeout == \u001b[32m0.0\u001b[39m:\n\u001b[32m   1074\u001b[39m                 \u001b[38;5;66;03m# non-blocking\u001b[39;00m\n\u001b[32m   1075\u001b[39m                 \u001b[38;5;28;01mraise\u001b[39;00m \u001b[38;5;167;01mValueError\u001b[39;00m(\u001b[33m\"\u001b[39m\u001b[33mdo_handshake_on_connect should not be specified for non-blocking sockets\u001b[39m\u001b[33m\"\u001b[39m)\n\u001b[32m-> \u001b[39m\u001b[32m1076\u001b[39m             \u001b[38;5;28;43mself\u001b[39;49m\u001b[43m.\u001b[49m\u001b[43mdo_handshake\u001b[49m\u001b[43m(\u001b[49m\u001b[43m)\u001b[49m\n\u001b[32m   1077\u001b[39m \u001b[38;5;28;01mexcept\u001b[39;00m:\n\u001b[32m   1078\u001b[39m     \u001b[38;5;28;01mtry\u001b[39;00m:\n",
      "\u001b[36mFile \u001b[39m\u001b[32m~/miniconda3/lib/python3.13/ssl.py:1372\u001b[39m, in \u001b[36mSSLSocket.do_handshake\u001b[39m\u001b[34m(self, block)\u001b[39m\n\u001b[32m   1370\u001b[39m     \u001b[38;5;28;01mif\u001b[39;00m timeout == \u001b[32m0.0\u001b[39m \u001b[38;5;129;01mand\u001b[39;00m block:\n\u001b[32m   1371\u001b[39m         \u001b[38;5;28mself\u001b[39m.settimeout(\u001b[38;5;28;01mNone\u001b[39;00m)\n\u001b[32m-> \u001b[39m\u001b[32m1372\u001b[39m     \u001b[38;5;28;43mself\u001b[39;49m\u001b[43m.\u001b[49m\u001b[43m_sslobj\u001b[49m\u001b[43m.\u001b[49m\u001b[43mdo_handshake\u001b[49m\u001b[43m(\u001b[49m\u001b[43m)\u001b[49m\n\u001b[32m   1373\u001b[39m \u001b[38;5;28;01mfinally\u001b[39;00m:\n\u001b[32m   1374\u001b[39m     \u001b[38;5;28mself\u001b[39m.settimeout(timeout)\n",
      "\u001b[31mKeyboardInterrupt\u001b[39m: "
     ]
    }
   ],
   "source": [
    "#!/usr/bin/env python\n",
    "# -*- coding: utf-8 -*-\n",
    "\n",
    "import json\n",
    "import random\n",
    "import time\n",
    "import os\n",
    "import sys\n",
    "\n",
    "import pandas as pd\n",
    "import requests\n",
    "\n",
    "# -------------------------------------------------\n",
    "# Config\n",
    "# -------------------------------------------------\n",
    "\n",
    "# Path to your CSV (adjust if needed)\n",
    "CSV_PATH = os.path.join(\"..\", \"data\", \"recipes-with-nutrition.csv\")\n",
    "\n",
    "# USDA API\n",
    "API_KEY = \"YTu6rNh3VVltd0pGa3XgzvcXiMxbWU0ohawDTWD5\"  # <-- your key\n",
    "BASE_URL = \"https://api.nal.usda.gov/fdc/v1/foods/search\"\n",
    "\n",
    "# Where to save generated QA pairs\n",
    "OUTPUT_JSON = \"question_answers.json\"\n",
    "\n",
    "# Simple in-memory cache: ingredient_name -> (cal_per_g, pro_per_g)\n",
    "FOOD_CACHE = {}\n",
    "\n",
    "\n",
    "# -------------------------------------------------\n",
    "# USDA LOOKUP (same logic, with caching)\n",
    "# -------------------------------------------------\n",
    "\n",
    "def get_food_calories(food_name, weight_grams):\n",
    "    \"\"\"\n",
    "    Return (cal_per_gram, protein_per_gram) for a food using USDA API.\n",
    "    Logic is kept the same as your version, but wrapped in a cache.\n",
    "    \"\"\"\n",
    "    key = (food_name or \"\").strip().lower()\n",
    "    if key in FOOD_CACHE:\n",
    "        return FOOD_CACHE[key]\n",
    "\n",
    "    params = {\n",
    "        \"query\": food_name,\n",
    "        \"api_key\": API_KEY,\n",
    "        \"pageSize\": 1,\n",
    "    }\n",
    "    data = None\n",
    "    for attempt in range(8):\n",
    "        r = requests.get(BASE_URL, params=params)\n",
    "        if r.status_code == 200 and \"application/json\" in r.headers.get(\"Content-Type\", \"\"):\n",
    "            data = r.json()\n",
    "            print(f\"✅ Search OK: {food_name}\")\n",
    "            break\n",
    "        print(f\"  Retry search ({attempt+1}/8) for {food_name}...\")\n",
    "        time.sleep(0.3 * (attempt + 1))\n",
    "\n",
    "    if not data or \"foods\" not in data or len(data[\"foods\"]) == 0:\n",
    "        print(f\"❌ Search failed: {food_name}\")\n",
    "        FOOD_CACHE[key] = (0.0, 0.0)\n",
    "        return FOOD_CACHE[key]\n",
    "\n",
    "    fdc_id = data[\"foods\"][0][\"fdcId\"]\n",
    "    print(\"  FDC ID:\", fdc_id)\n",
    "\n",
    "    # Food details\n",
    "    detail_url = f\"https://api.nal.usda.gov/fdc/v1/food/{fdc_id}?api_key={API_KEY}\"\n",
    "    detail_data = None\n",
    "    for attempt in range(8):\n",
    "        resp = requests.get(detail_url)\n",
    "        if resp.status_code == 200 and \"application/json\" in resp.headers.get(\"Content-Type\", \"\"):\n",
    "            detail_data = resp.json()\n",
    "            print(f\"✅ DATA Fetch: {food_name}\")\n",
    "            break\n",
    "        print(f\"  Retry details ({attempt+1}/8) for {food_name}...\")\n",
    "        time.sleep(0.3 * (attempt + 1))\n",
    "\n",
    "    if not detail_data:\n",
    "        print(f\"❌ Detail fetch failed: {food_name}\")\n",
    "        FOOD_CACHE[key] = (0.0, 0.0)\n",
    "        return FOOD_CACHE[key]\n",
    "\n",
    "    calories = 0.0\n",
    "    proteins = 0.0\n",
    "\n",
    "    # USDA can be two shapes: (nutrientId/value) or (nutrient: {id}, amount)\n",
    "    for nutrient in detail_data.get(\"foodNutrients\", []):\n",
    "        if not isinstance(nutrient, dict):\n",
    "            continue\n",
    "\n",
    "        nid = nutrient.get(\"nutrientId\")\n",
    "        if nid is None:\n",
    "            nut_obj = nutrient.get(\"nutrient\", {}) or {}\n",
    "            nid = nut_obj.get(\"id\")\n",
    "\n",
    "        value = nutrient.get(\"value\")\n",
    "        if value is None:\n",
    "            value = nutrient.get(\"amount\", 0.0)\n",
    "\n",
    "        if nid == 1008:      # Energy\n",
    "            calories = float(value)\n",
    "        elif nid == 1003:    # Protein\n",
    "            proteins = float(value)\n",
    "\n",
    "    print(\"    raw calories (per USDA serving):\", calories)\n",
    "    print(\"    raw proteins (per USDA serving):\", proteins)\n",
    "\n",
    "    serving_size = detail_data.get(\"servingSize\")\n",
    "    if not serving_size or serving_size == 0:\n",
    "        # fall back: assume values are per 100 g\n",
    "        cal_per_gram = calories / 100.0\n",
    "        pro_per_gram = proteins / 100.0\n",
    "    else:\n",
    "        cal_per_gram = calories / float(serving_size)\n",
    "        pro_per_gram = proteins / float(serving_size)\n",
    "\n",
    "    print(\"    final per gram c:\", cal_per_gram)\n",
    "    print(\"    final per gram p:\", pro_per_gram)\n",
    "    print(\"    =======================================\")\n",
    "\n",
    "    FOOD_CACHE[key] = (cal_per_gram, pro_per_gram)\n",
    "    return FOOD_CACHE[key]\n",
    "\n",
    "\n",
    "# -------------------------------------------------\n",
    "# Question templates\n",
    "# -------------------------------------------------\n",
    "\n",
    "calorie_templates_under = [\n",
    "    \"Give me a {diet} {meal} under {cal} calories.\",\n",
    "    \"Suggest a {cuisine} recipe below {cal} calories.\",\n",
    "    \"What can I eat for {meal} under {cal} calories?\",\n",
    "    \"Recommend a {diet} friendly {meal} with less than {cal} calories.\",\n",
    "    \"I need a {meal} option with calories under {cal}.\",\n",
    "    \"Find me something {cuisine} style under {cal} calories.\",\n",
    "    \"What is a good {meal} choice below {cal} calories?\",\n",
    "    \"Show me a low-calorie {meal} under {cal} calories.\",\n",
    "    \"Show me a {health} recipe under {cal} calories.\",\n",
    "    \"Suggest a {health} friendly {meal} under {cal} calories.\",\n",
    "    \"Give me a {health} and {diet} option below {cal} calories.\",\n",
    "    \"Find a {cuisine} recipe that is {health} and under {cal} calories.\",\n",
    "    \"Recommend a {meal} that is {health} and under {cal} calories.\",\n",
    "    \"I'm trying to stay under {cal} calories — what {meal} would you suggest?\",\n",
    "    \"Help me choose a {diet} {meal} under {cal} calories in {cuisine} cuisine.\",\n",
    "    \"Suggest a light {meal} under {cal} calories that still feels satisfying.\",\n",
    "    \"What is a simple {cuisine} {meal} I can have under {cal} calories?\",\n",
    "]\n",
    "\n",
    "calorie_templates_above = [\n",
    "    \"Give me a {diet} {meal} above {cal} calories.\",\n",
    "    \"Suggest a hearty {cuisine} recipe over {cal} calories.\",\n",
    "    \"What can I eat for {meal} with more than {cal} calories?\",\n",
    "    \"Recommend a higher-calorie {meal} above {cal} calories.\",\n",
    "    \"Find me a {cuisine} style dish with calories above {cal}.\",\n",
    "    \"Show me a filling {meal} that’s over {cal} calories.\",\n",
    "    \"Suggest a {health} recipe with more than {cal} calories.\",\n",
    "    \"I need a more filling {meal} with at least {cal} calories.\",\n",
    "    \"What’s a hearty {diet} {meal} above {cal} calories?\",\n",
    "    \"Recommend a satisfying {cuisine} dish over {cal} calories.\",\n",
    "]\n",
    "\n",
    "calorie_templates_exact = [\n",
    "    \"Give me a {diet} {meal} around {cal} calories.\",\n",
    "    \"Suggest a {cuisine} recipe that’s approximately {cal} calories.\",\n",
    "    \"Recommend a {meal} close to {cal} calories.\",\n",
    "    \"Find a {health} friendly {meal} that’s about {cal} calories.\",\n",
    "    \"Show me a {cuisine} recipe near {cal} calories.\",\n",
    "    \"I’m aiming for about {cal} calories — what {meal} fits that?\",\n",
    "    \"What is a {diet} {meal} roughly {cal} calories in {cuisine} cuisine?\",\n",
    "]\n",
    "\n",
    "protein_templates = [\n",
    "    \"Recommend a {meal} with at least {protein_min} g protein per serving.\",\n",
    "    \"I want a high-protein {meal} (≥ {protein_min} g protein). Any suggestions?\",\n",
    "    \"Find a {cuisine} {meal} that has at least {protein_min} g protein.\",\n",
    "    \"Suggest a {diet} {meal} that’s rich in protein (≥ {protein_min} g).\",\n",
    "    \"What is a good {meal} option with at least {protein_min} g protein?\",\n",
    "]\n",
    "\n",
    "diet_templates = [\n",
    "    \"I’d like a {diet} {meal} in {cuisine} style that fits a {health} lifestyle.\",\n",
    "    \"Suggest a {diet} {meal} that works well for someone eating {health}.\",\n",
    "    \"Give me a {diet} {meal} in {cuisine} cuisine I could eat regularly.\",\n",
    "    \"What is a simple {diet} {meal} that’s also {health}?\",\n",
    "]\n",
    "\n",
    "all_calorie_templates = (\n",
    "    [(\"under\", t) for t in calorie_templates_under] +\n",
    "    [(\"above\", t) for t in calorie_templates_above] +\n",
    "    [(\"exact\", t) for t in calorie_templates_exact]\n",
    ")\n",
    "\n",
    "\n",
    "# -------------------------------------------------\n",
    "# Helper functions\n",
    "# -------------------------------------------------\n",
    "\n",
    "def clean_str(s: str) -> str:\n",
    "    \"\"\"Strip whitespace + stray quotes/brackets from a label.\"\"\"\n",
    "    return s.strip().strip(\"[]'\\\" \").strip()\n",
    "\n",
    "\n",
    "def normalize_label(value, default=\"\"):\n",
    "    \"\"\"\n",
    "    Turn meal_type / cuisine_type / diet_labels into a single clean string.\n",
    "    Handles lists, CSV strings, JSON-list strings, etc.\n",
    "    \"\"\"\n",
    "    # List-like → choose one\n",
    "    if isinstance(value, list):\n",
    "        candidates = [clean_str(str(v)) for v in value if clean_str(str(v))]\n",
    "        return random.choice(candidates) if candidates else default\n",
    "\n",
    "    if isinstance(value, str):\n",
    "        s = value.strip()\n",
    "        if not s:\n",
    "            return default\n",
    "\n",
    "        # JSON-like list as string\n",
    "        if s.startswith(\"[\") and s.endswith(\"]\"):\n",
    "            try:\n",
    "                parsed = json.loads(s)\n",
    "                return normalize_label(parsed, default)\n",
    "            except Exception:\n",
    "                # fall through to CSV-like handling\n",
    "                pass\n",
    "\n",
    "        # CSV-like string\n",
    "        if \",\" in s:\n",
    "            parts = [clean_str(p) for p in s.split(\",\") if clean_str(p)]\n",
    "            return random.choice(parts) if parts else default\n",
    "\n",
    "        # simple single label\n",
    "        return clean_str(s) or default\n",
    "\n",
    "    return default\n",
    "\n",
    "\n",
    "def normalize_label_list(value):\n",
    "    \"\"\"\n",
    "    For health_labels: always return a clean list of strings.\n",
    "    Accepts list, CSV string, or JSON-list string.\n",
    "    \"\"\"\n",
    "    if isinstance(value, list):\n",
    "        return [clean_str(str(v)) for v in value if clean_str(str(v))]\n",
    "\n",
    "    if isinstance(value, str):\n",
    "        s = value.strip()\n",
    "        if not s:\n",
    "            return []\n",
    "        # JSON-like list string\n",
    "        if s.startswith(\"[\") and s.endswith(\"]\"):\n",
    "            try:\n",
    "                parsed = json.loads(s)\n",
    "                return normalize_label_list(parsed)\n",
    "            except Exception:\n",
    "                pass\n",
    "        # CSV-like\n",
    "        return [clean_str(p) for p in s.split(\",\") if clean_str(p)]\n",
    "\n",
    "    return []\n",
    "\n",
    "\n",
    "def r2(x):\n",
    "    \"\"\"Round safely to 2 decimals (handle None).\"\"\"\n",
    "    if x is None:\n",
    "        return None\n",
    "    return round(float(x), 2)\n",
    "\n",
    "\n",
    "def calorie_bounds_for_meal(meal: str):\n",
    "    \"\"\"\n",
    "    Give realistic [min, max] calorie range for a single serving of a meal.\n",
    "    This keeps questions reasonable like 200–1200 kcal, not 7000.\n",
    "    \"\"\"\n",
    "    m = (meal or \"\").lower()\n",
    "    if \"breakfast\" in m:\n",
    "        return 150, 800\n",
    "    if \"snack\" in m:\n",
    "        return 50, 600\n",
    "    # lunch/dinner/other meals\n",
    "    return 250, 1500\n",
    "\n",
    "\n",
    "# -------------------------------------------------\n",
    "# Main QA generator\n",
    "# -------------------------------------------------\n",
    "\n",
    "def create_qa_pairs_with_ingredient_calories(df, num_samples=100):\n",
    "    \"\"\"\n",
    "    Generate QA pairs based on the recipes DataFrame.\n",
    "    Saves to OUTPUT_JSON every 5 valid pairs and prints progress.\n",
    "    \"\"\"\n",
    "    qa_pairs = []\n",
    "    target = num_samples\n",
    "    attempts = 0\n",
    "    max_attempts = num_samples * 20  # safety so we don't loop forever\n",
    "\n",
    "    print(f\"Starting QA generation for {target} pairs...\")\n",
    "    while len(qa_pairs) < target and attempts < max_attempts:\n",
    "        attempts += 1\n",
    "\n",
    "        row = df.sample(1).iloc[0]\n",
    "        recipe = row.get(\"recipe_name\", \"a healthy dish\")\n",
    "\n",
    "        # --- servings handling ---\n",
    "        servings_value = row.get(\"servings\", 1)\n",
    "        try:\n",
    "            servings = int(servings_value)\n",
    "        except (TypeError, ValueError):\n",
    "            servings = 1\n",
    "        if servings <= 0:\n",
    "            servings = 1\n",
    "\n",
    "        # labels\n",
    "        meal_raw    = row.get(\"meal_type\", \"meal\")\n",
    "        diet_raw    = row.get(\"diet_labels\", \"balanced\")\n",
    "        cuisine_raw = row.get(\"cuisine_type\", \"any\")\n",
    "        health_raw  = row.get(\"health_labels\", \"\")\n",
    "\n",
    "        meal        = normalize_label(meal_raw, \"meal\")\n",
    "        diet        = normalize_label(diet_raw, \"balanced\")\n",
    "        cuisine     = normalize_label(cuisine_raw, \"any\")\n",
    "        health_list = normalize_label_list(health_raw)\n",
    "\n",
    "        # ingredients\n",
    "        ingredients_raw = row.get(\"ingredients\", [])\n",
    "        if isinstance(ingredients_raw, str):\n",
    "            try:\n",
    "                ingredients_list = json.loads(ingredients_raw)\n",
    "            except Exception:\n",
    "                ingredients_list = []\n",
    "        else:\n",
    "            ingredients_list = ingredients_raw or []\n",
    "\n",
    "        ingredients_with_cal = []\n",
    "        total_cal_recipe = 0.0\n",
    "        total_pro_recipe = 0.0\n",
    "\n",
    "        for item in ingredients_list:\n",
    "            if isinstance(item, dict):\n",
    "                food_name = (\n",
    "                    item.get(\"food\")\n",
    "                    or item.get(\"ingredient\")\n",
    "                    or \"ingredient\"\n",
    "                )\n",
    "                weight = item.get(\"weight\", 0.0)\n",
    "            else:\n",
    "                food_name = str(item)\n",
    "                weight = 0.0\n",
    "\n",
    "            if weight is None:\n",
    "                weight = 0.0\n",
    "\n",
    "            if weight <= 0:\n",
    "                continue\n",
    "\n",
    "            cal_per_unit, pro_per_unit = get_food_calories(food_name, weight)\n",
    "\n",
    "            ingredient_total_cal = cal_per_unit * weight\n",
    "            ingredient_total_pro = pro_per_unit * weight\n",
    "\n",
    "            total_cal_recipe += ingredient_total_cal\n",
    "            total_pro_recipe += ingredient_total_pro\n",
    "\n",
    "            cal_per_serv = ingredient_total_cal / servings\n",
    "            pro_per_serv = ingredient_total_pro / servings\n",
    "\n",
    "            ingredients_with_cal.append({\n",
    "                \"ingredient\": food_name,\n",
    "                \"weight_g_or_ml\": r2(weight),\n",
    "                \"calories_per_unit\": r2(cal_per_unit),\n",
    "                \"total_calories\": r2(cal_per_serv),   # per serving\n",
    "                \"protein\": r2(pro_per_serv),          # per serving\n",
    "            })\n",
    "\n",
    "        if not ingredients_with_cal:\n",
    "            # nothing usable; try another recipe\n",
    "            continue\n",
    "\n",
    "        calories_per_serving = total_cal_recipe / servings if servings > 0 else 0.0\n",
    "        protein_per_serving  = total_pro_recipe / servings if servings > 0 else 0.0\n",
    "\n",
    "        # realism filter\n",
    "        cal_min, cal_max = calorie_bounds_for_meal(meal)\n",
    "        if calories_per_serving <= 0 or calories_per_serving > cal_max * 2:\n",
    "            print(f\"Skipping '{recipe}' due to unrealistic calories per serving: {calories_per_serving:.1f}\")\n",
    "            continue\n",
    "\n",
    "        if not (cal_min <= calories_per_serving <= cal_max):\n",
    "            print(f\"Skipping '{recipe}' ({calories_per_serving:.1f} kcal/serv) outside [{cal_min}, {cal_max}]\")\n",
    "            continue\n",
    "\n",
    "        if protein_per_serving < 0 or protein_per_serving > 150:\n",
    "            print(f\"Skipping '{recipe}' due to unrealistic protein per serving: {protein_per_serving:.1f}\")\n",
    "            continue\n",
    "\n",
    "        # health labels for text\n",
    "        if health_list:\n",
    "            p = random.random()\n",
    "            if p < 0.60:\n",
    "                selected_health = [random.choice(health_list)]\n",
    "            elif p < 0.90:\n",
    "                k = min(2, len(health_list))\n",
    "                selected_health = random.sample(health_list, k)\n",
    "            else:\n",
    "                k = min(3, len(health_list))\n",
    "                selected_health = random.sample(health_list, k)\n",
    "        else:\n",
    "            selected_health = []\n",
    "        health_str = \", \".join(selected_health) if selected_health else \"healthy\"\n",
    "\n",
    "        # choose question family\n",
    "        question_family = random.choice(\n",
    "            [\"calorie\", \"calorie\", \"calorie\", \"protein\", \"diet\"]\n",
    "        )\n",
    "\n",
    "        base_cal = int(calories_per_serving)\n",
    "\n",
    "        if question_family == \"calorie\":\n",
    "            tmpl_type, q_template = random.choice(all_calorie_templates)\n",
    "\n",
    "            if tmpl_type == \"under\":\n",
    "                lower = base_cal + 20\n",
    "                upper = min(base_cal + 200, cal_max)\n",
    "                if lower >= upper:\n",
    "                    lower = min(base_cal + 10, cal_max - 10)\n",
    "                    upper = max(lower + 10, cal_max)\n",
    "                cal_for_q = random.randint(max(lower, cal_min + 20), upper)\n",
    "\n",
    "            elif tmpl_type == \"above\":\n",
    "                upper = max(cal_min + 50, base_cal - 20)\n",
    "                lower = max(cal_min, upper - 200)\n",
    "                if lower >= upper:\n",
    "                    lower = max(cal_min, base_cal - 100)\n",
    "                cal_for_q = random.randint(lower, upper)\n",
    "\n",
    "            else:  # exact\n",
    "                delta = random.randint(10, 80)\n",
    "                lower = max(cal_min, base_cal - delta)\n",
    "                upper = min(cal_max, base_cal + delta)\n",
    "                if lower >= upper:\n",
    "                    upper = max(lower + 20, lower + delta)\n",
    "                cal_for_q = random.randint(lower, upper)\n",
    "\n",
    "            question = q_template.format(\n",
    "                diet=diet,\n",
    "                meal=meal,\n",
    "                cuisine=cuisine,\n",
    "                cal=cal_for_q,\n",
    "                health=health_str,\n",
    "            )\n",
    "\n",
    "        elif question_family == \"protein\" and protein_per_serving > 3:\n",
    "            protein_min = int(max(3, protein_per_serving * random.uniform(0.5, 0.8)))\n",
    "            tmpl = random.choice(protein_templates)\n",
    "            question = tmpl.format(\n",
    "                diet=diet,\n",
    "                meal=meal,\n",
    "                cuisine=cuisine,\n",
    "                health=health_str,\n",
    "                protein_min=protein_min,\n",
    "            )\n",
    "\n",
    "        else:\n",
    "            tmpl = random.choice(diet_templates)\n",
    "            question = tmpl.format(\n",
    "                diet=diet,\n",
    "                meal=meal,\n",
    "                cuisine=cuisine,\n",
    "                health=health_str,\n",
    "            )\n",
    "\n",
    "        answer = {\n",
    "            \"recipe_name\": recipe,\n",
    "            \"calories\": r2(calories_per_serving),\n",
    "            \"proteins\": r2(protein_per_serving),\n",
    "            \"ingredients\": ingredients_with_cal,\n",
    "        }\n",
    "\n",
    "        qa = {\"question\": question, \"answer\": answer}\n",
    "        qa_pairs.append(qa)\n",
    "\n",
    "        n = len(qa_pairs)\n",
    "        if n % 10 == 0 or n == target:\n",
    "            print(f\"Progress: {n}/{target} pairs generated\")\n",
    "\n",
    "        if OUTPUT_JSON is not None and (n % 5 == 0 or n == target):\n",
    "            with open(OUTPUT_JSON, \"w\", encoding=\"utf-8\") as f:\n",
    "                json.dump(qa_pairs, f, indent=4)\n",
    "            print(f\"💾 Saved {n} pairs to {OUTPUT_JSON}\")\n",
    "\n",
    "    if len(qa_pairs) < target:\n",
    "        print(f\"⚠️ Only generated {len(qa_pairs)} pairs out of requested {target} (many filtered as unrealistic).\")\n",
    "\n",
    "    return qa_pairs\n",
    "\n",
    "\n",
    "# -------------------------------------------------\n",
    "# Entry point\n",
    "# -------------------------------------------------\n",
    "\n",
    "def main():\n",
    "    # Load CSV\n",
    "    if not os.path.exists(CSV_PATH):\n",
    "        print(f\"❌ CSV not found at {CSV_PATH}\")\n",
    "        sys.exit(1)\n",
    "\n",
    "    print(f\"Loading recipes from: {CSV_PATH}\")\n",
    "    df = pd.read_csv(CSV_PATH)\n",
    "    print(f\"Loaded {len(df)} recipes.\")\n",
    "\n",
    "    NUM_SAMPLES = 50  # change as needed\n",
    "    qa_output = create_qa_pairs_with_ingredient_calories(df, num_samples=NUM_SAMPLES)\n",
    "    print(f\"✅ Done. Generated {len(qa_output)} QA pairs total.\")\n",
    "    print(f\"Output saved to: {OUTPUT_JSON}\")\n",
    "\n",
    "\n",
    "if __name__ == \"__main__\":\n",
    "    main()"
   ]
  }
 ],
 "metadata": {
  "kernelspec": {
   "display_name": ".venv",
   "language": "python",
   "name": "python3"
  },
  "language_info": {
   "codemirror_mode": {
    "name": "ipython",
    "version": 3
   },
   "file_extension": ".py",
   "mimetype": "text/x-python",
   "name": "python",
   "nbconvert_exporter": "python",
   "pygments_lexer": "ipython3",
   "version": "3.13.1"
  }
 },
 "nbformat": 4,
 "nbformat_minor": 2
}
